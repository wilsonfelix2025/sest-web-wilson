using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Configuration;
using System.Collections.Generic;
using System.Net;
using System.Net.Mail;
using System.Text;
using System.Threading.Tasks;

namespace SestWeb.Infra.Services
{
    public class EmailService
    {
        private readonly IConfiguration _configuration;
        private readonly IHttpContextAccessor _httpContextAccessor;
        private SmtpClient _smtpClient;
        private ConfiguraçãoSmtp _configuraçãoSmtp = new ConfiguraçãoSmtp();
        private string _template =
           "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\"><html xmlns=\"http://www.w3.org/1999/xhtml\"> <head> <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"> <meta name=\"format-detection\" content=\"telephone=no\"> <meta name=\"viewport\" content=\"width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no;\"> <meta http-equiv=\"X-UA-Compatible\" content=\"IE=9; IE=8; IE=7; IE=EDGE\"> <title>GTEP | Mensagem de resposta</title> <style type=\"text/css\" id=\"hs-inline-css\"> #outlook a{padding:0;}.ReadMsgBody{width:100%;}.ExternalClass *{line-height:125%!important}.ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div{line-height:125%!important;}body,table,td,p,a,li,blockquote{-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%;}table,td{mso-table-lspace:0pt; mso-table-rspace:0pt;}body{margin:0; padding:0;}img{-ms-interpolation-mode:bicubic; border:0; height:auto; line-height:100%; outline:none; text-decoration:none; max-width: 145px;}/* svg{height: auto; max-width: 100%;}*/ table{border-collapse:collapse !important;}body, #backgroundTable, #bodyCell{height:100% !important; width:100% !important; margin:0; padding:0;}a:link,a:visited{text-decoration:none; border-bottom:none;}.appleFooter a{color:#999999 !important; text-decoration:none !important;}.appleLink a{color:#ffffff !important; text-decoration:none !important;}#bodyCell{padding:75px 20px 20px;}#bl #bodyCell{padding: 20px 20px 0;}body, #backgroundTable{background-color:#eeeeee; font-family: Helvetica, Arial, sans-serif;}#bl #backgroundTable{background-color:#ffffff;}table td{font-family: Helvetica, Arial, sans-serif;}table th{margin:0 !important; vertical-align:middle; font-weight:normal;}#templateContainer{width:600px; background-color:#ffffff;}#templateBody{background-color:#ffffff;}.templateContent{color: #666666; font-family: Helvetica, Arial, sans-serif; font-size:16px; line-height:20px; background: #f6f6f6; padding:10px 100px 0 100px;}.templateContent a:link,.templateContent a:visited,.templateContent a .yshortcuts{color:#0000cc; text-decoration:none; border-bottom:none;}.templateContent.sections{padding-right:70px; padding-left:70px;}#bl .templateContent{border-bottom: none; padding: 20px 50px 0;}body, table, td, p, a, a span, strong{font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none;}a{color:#0000cc;}p{color: #666666; margin:0; padding:0; line-height:24px; mso-line-height-rule:exactly;}p + p{margin-top:20px;}p a{color:#0000cc; font-weight:normal;}strong{font-weight:600; letter-spacing:.25px;}span.preheader{display:none !important;}#templatetagline{background-color:#ffffff;}.tagline{border-top:2px solid #0000cc;}#bl .tagline{border-top:none;}.taglineContent{color:#0000cc; font-size:11px; line-height:16px; font-weight:600; letter-spacing:.2px;}.taglineContent a, .taglineContent a:link,.taglineContent a:visited,.taglineContent a .yshortcuts{color:#0000cc; text-decoration:none; border-bottom:none;}.logo{padding-top:20px; padding-bottom:20px;}.footerLogo{padding-top:35px; padding-bottom:20px;}.headerContent{color:#0000cc; font-size:32px; line-height:43px; padding:0 20px 20px 20px; font-weight:300;}#bl .headerContent{color:#161D25; font-size:20px; line-height:28px; font-weight:600; padding-top:30px;}.subheaderContent{color:#5B6B7F; font-size:15px; line-height:24px; padding:0 20px 40px 20px;}.subheaderContent a{color:#0000cc !important; text-decoration:none !important; border-bottom:none !important;}.ctaContent{padding-top:15px; padding-bottom:15px;}#bl .ctaContent{padding-top:25px;}.footer{border-top:1px solid #efefef; padding-right:20px; padding-left:20px;}#bl .footer{padding:30px 20px 30px;}#footerSettings{background-color:#eeeeee;}#bl #footerSettings{background-color:#F9F9F9;}.footerContent, .footerSettingsContent{color:#9ca8b7; font-size:12px; line-height:18px; text-align:center;}.footerSettingsContent a:link,.footerSettingsContent a:visited,.footerSettingsContent a .yshortcuts{color:#0000cc; text-decoration:none;}#bl .footerSettingsContent a:link,#bl .footerSettingsContent a:visited,#bl .footerSettingsContent a .yshortcuts{text-decoration:underline;}.footer a.socialMediaIcon{padding-right:5px;}#calloutBanner{background-color:#0000cc;}.templateContent.callout{padding-right:70px; padding-left:70px; border-bottom:2px solid #F98700;}.calloutHeader, .calloutHeader a{color:#ffffff; font-size:18px; line-height:26px; font-weight:600; text-transform:uppercase; letter-spacing:1px;}.calloutContent, .calloutContent p{color:#ffffff;}.letterContent{color:#0000cc; font-size:16px; line-height:24px; padding-top:15px;}.letterContent.no-image{padding-top:0px;}.sectionsWrapper{margin-bottom:20px;}.sectionHeader, .sectionHeader a{color:#0000cc; font-size:12px; line-height:20px; font-weight:600; text-transform:uppercase; letter-spacing:1px;}.sectionContent{color:#5B6B7F; font-size:13px; line-height:19px; font-weight:normal; padding:10px 0 5px 0;}.sectionContent a{color:#0000cc;}.section1{background-color:#FEF6E9;}.section2{background-color:#FEEED4;}.section3{background-color:#FDE5BE;}.section4{background-color:#FDDDA9;}.sectionImage{padding:35px 0px 30px;}.sectionBody{padding:35px 0 30px 30px;}.paddedContent{padding:0 25px; border-top:1px solid #efefef;}.paddingBottom{padding-bottom: 30px;}.blogpostContent, .featuredPostContent{font-size:14px; line-height:20px; padding-top:30px;}.blogTopic, .blogAuthor, .blogletterTitle, .featuredPostHeader, .featuredPostHeader a{font-size:16px; line-height:22px; font-weight:600;}.blogletterTitle{padding:30px 0 20px;}.blogletterDescription{padding:0 0 20px;}/* Featured Post Styles */ .featuredPostsWrapper{margin-bottom:20px;}.featuredPostContent{padding:10px 0 5px 0;}.featuredPostContent p{font-size:13px; line-height:20px; font-weight:normal;}.featuredPostContent p + p{margin-top:10px;}.featuredPostContent a{color:#0000cc;}a.featuredPostReadMore{font-weight:600;}.featuredPostImage{padding:0 0 40px;}.featuredPostBody{padding:0 0 40px 25px;}.rectangleBorder{border-collapse:separate; border:1px solid #efefef; -moz-border-radius:4px; border-radius:4px; padding:0 25px;}.editorsPost{border-bottom:1px solid #efefef; padding:25px 0 20px;}.editorsPostHeader, .editorsPostReadMoreLink{font-size:14px; line-height:21px; font-weight:600;}a.editorsPostReadMoreLink{color:#0000cc;}.editorsPostSource{font-size:12px; text-transform:uppercase; padding-top:5px;}.editorsPostSource a:-webkit-any-link{color:inherit !important;}/* Editor Bios */ .editor{padding-bottom:20px;}.editorBio{font-size:14px; line-height:21px; padding:5px 0 25px;}.editorImage{padding-right:20px;}.editorContent{font-size:12px; line-height:16px;}.editorTitle{}/* Modifiers */ .no-border{border-top: none; border-bottom:none;}</style> <style type=\"text/css\"> @media screen and (min-width:600px){.desktop-hide{display:none !important;}}@media screen and (max-width:650px){#backgroundTable{width:100% !important; min-width:100% !important;}#templateContainer{max-width:600px !important; width:100% !important; min-width:100% !important;}}@media only screen and (max-width:520px){body,table,td,p,a,li,blockquote{-webkit-text-size-adjust:none !important;}body{width:100% !important; min-width:100% !important;}#bodyCell{padding:0 !important;}svg{width: 30%;}.tagline{border-top:0 !important; padding-top:20px !important;}.templateContent{padding-left:20px !important; padding-right:20px !important;}.headerContent{font-size:28px !important; line-height:38px !important;}#bl .headerContent{font-size:18px !important; line-height:24px !important; padding-top:10px !important;}.subheaderContent{padding-bottom:25px !important;}.sectionHeader, .sectionContent{text-align:center !important;}.letterContent{padding-left:0 !important; padding-right:0 !important;}.calloutHeader{padding-top:30px !important;}.ctaContent.callout{padding-bottom:10px !important;}.footerContent, .footerSettingsContent{font-size:12px !important;}a.mobile-button{font-size:14px !important;}.mob-column{float:none !important; display:block !important; width:100% !important;}.featuredPostImage img, .blogpostImage img{width:100% !important; max-height:100% !important;}.mob-hide{display:none !important;}.mob-center{text-align:center!important;}.paddedContent{padding: 0 !important;}.paddedContent.mob-no-border{border-top: none!important;}.paddedContent.paddingBottom{padding-bottom: 30px !important;}td.templateContent.sections, .sectionImage, .sectionBody, .featuredPostBody, .featuredPostImage{padding-left:0 !important; padding-right:0 !important;}.sectionImage{padding-top:30px !important; padding-bottom:0 !important;}.sectionBody{padding-top:15px !important;}.featuredPostBody{padding-bottom:30px !important;}.featuredPostImage{padding-bottom:20px !important;}.featuredPostContent{padding-top: 5px !important;}.editorsPostContent{width:90% !important;}.editorsPostReadMore{width:10% !important;}.blogTopic, .blogAuthor, .blogletterTitle, .featuredPostHeader, .featuredPostHeader a{font-size:14px !important; line-height:20px !important;}.paddingBottom{padding-bottom: 30px !important;}}@media only screen and (max-width:440px){p.smallText{font-size:13px !important;}}</style><!--[if mso]> <style type=\"text/css\"> body, table, td, p, a, a span, strong{font-family:Helvetica, Arial, sans-serif !important;}</style><![endif]--> <meta name=\"x-apple-disable-message-reformatting\"> <meta name=\"robots\" content=\"noindex,follow\"> </head> <body leftmargin=\"0\" marginwidth=\"0\" topmargin=\"0\" marginheight=\"0\" offset=\"0\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; height:100% !important; width:100% !important; margin:0; padding:0; background-color:#eeeeee; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none\" height=\"100%\" width=\"100%\" bgcolor=\"#eeeeee\"> <table align=\"center\" bgcolor=\"#eeeeee\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" height=\"100%\" width=\"100%\" id=\"backgroundTable\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; text-decoration:none; border-bottom:none; height:100% !important; width:100% !important; margin:0; padding:0; background-color:#eeeeee; font-family: Helvetica, Arial, sans-serif\"> <tbody> <tr> <td align=\"center\" valign=\"top\" id=\"bodyCell\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; height:100% !important; width:100% !important; margin:0; padding:75px 20px 20px\" height=\"100%\" width=\"100%\"> <table width=\"600\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" id=\"templateContainer\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none; width:600px; background-color:#ffffff\" bgcolor=\"#ffffff\"> <tbody> <tr> <td align=\"center\" valign=\"top\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" id=\"templateWrapper\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none\"> <tbody> <tr> <td align=\"center\" valign=\"top\" class=\"tagline\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; border-top:2px solid #0000cc; padding:0; background: #ffffff;\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"80%\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none;\"> <tbody> <tr> <td align=\"center\" valign=\"middle\" class=\"mob-hide\" width=\"30%\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif;\"> &nbsp; </td><td align=\"center\" valign=\"middle\" class=\"logo\" width=\"40%\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; padding-top:20px; padding:20px 0 10px 0;\"> <a href=\"#\" target=\"_blank\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none; data-hs-link-id=\"0\"> <img src=\"https://portalsest.gtep.civ.puc-rio.br/gtep-logo-email.svg\"> </a> </td><td align=\"right\" valign=\"middle\" class=\"mob-hide\" width=\"30%\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif\"> <a href=\"https://content.wistia.com/e2t/c/*W7CDT4H1ftp89W7Drc1s6MzkPF0/*W8VdcL57BLLFHW4gsh-S785FD80/5/f18dQhb0SbTH8YXNdxW8HrQ1B5D47MtW243RZm7v4vjJW7wVngj4C_R96W5q9cPw8yyv7RW1pgFH75yKtlsW5sPjVy3GCRYtW8tzLyD5y5jh-W1rfXlz1kRpb7W7YD3Zz66Rvy4N7Ykg3JQJJn6W3Lqnm_8q5FTlW67Tp-x8m7Y9zN5wM1SsnK8dsW5L1yJ85Fxwr5W6CHJ8d7v67dtW2hBQwB1MqhJKW7ldyjx608vBRW776qxc6TtcxqW22XQ4876pstKW78gBHw1Cy6w9W7qgqP47J-Gc7W1wh_4H1gPV_hW1CmQJc1Dc6ZYW1RYCd420Rln8W1V_BTC1CtGcJW2dDzlk773GYDW23Mwkd7HF1qbW7lYq2W1TkgS5W2bMGG67rTSQzW82mZPy673GW4W7w_tF56qY9Y_W6vm6bw5nXlThVZ4s5k9hRBMlVrX3l16Vzw8CW31d16S1mZ1PkN251NT9wY-13W5C9cHN2lJNvcV42cYP3nNLHwW41x8j34sprSpW31ZlHq4mwRkZN6cj7F7gV50hW3v3bNl5_5dj9w3xWwfqbymf4lJMFy02\" target=\"_blank\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none; color:#0000cc\" data-hs-link-id=\"0\"> &nbsp; </a> </td></tr></tbody> </table> </td></tr><tr> <td align=\"center\" valign=\"top\" class=\"templateContent\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; color: #666666; font-family: Helvetica, Arial, sans-serif; font-size:16px; line-height:20px; padding:10px 100px 0 100px\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none\"> <tbody> <tr> <td align=\"center\" valign=\"middle\" class=\"headerContent\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; color:#555; font-size:32px; line-height:43px; padding:0; font-weight:550\"> SESTTR </td></tr><tr> <td align=\"center\" valign=\"middle\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; color:#555; font-size:18px; line-height:23px; padding:20px 0 10px 0; font-weight:550\"> __TITULO__ </td></tr><tr> <td align=\"left\" valign=\"top\" class=\"letterContent\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; color:#0000cc; font-size:16px; line-height:24px;\"> <p style=\"margin-bottom: 1em; -webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none; color: #666666; margin:0; padding:0; line-height:25px; mso-line-height-rule:exactly\">__TEXTO__ </p></td></tr><tr> <td align=\"center\" valign=\"top\" class=\"ctaContent\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif;\"> <table width=\"100%\" border=\"0\" cellspacing=\"0\" cellpadding=\"0\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none\"> <tbody> <tr> <td align=\"center\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; padding:5px 0 10px 0\"> <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none\"> <tbody> <tr> <td align=\"center\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif\"> <div><!--[if mso]> <v:roundrect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"#\" style=\"height:35px;v-text-anchor:middle;width:120px;\" arcsize=\"10%\" strokecolor=\"#0000cc\" fillcolor=\"#0000cc\"> <w:anchorlock/> <center style=\"color:#ffffff;font-family:Helvetica, Arial, sans-serif;font-size:14px;font-weight:normal;\">Confirme seu e-mail</center> </v:roundrect><![endif]--><a href=\"__LINK_BOTAO__\" style=\"-ms-text-size-adjust:100%; padding: 15px 40px; font-family: Helvetica, Arial, sans-serif; border-bottom:none; background-color:#0000cc; border:1px solid #0000cc; border-radius:4px; color:#ffffff; display:inline-block; font-size:18px; font-weight:normal; line-height:35px; text-align:center; text-decoration:none; width:200px; -webkit-text-size-adjust:none; mso-hide:all\" class=\"mobile-button\" bgcolor=\"#0000cc\" align=\"center\" width=\"120\" data-hs-link-id=\"1\" target=\"_blank\">__TEXTO_BOTAO__</a> </font> </div></td></tr></tbody> </table> </td></tr></tbody> </table> </td></tr><tr> <td align=\"center\" valign=\"top\" class=\"footer\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; border-top:1px solid #efefef; padding-right:20px; padding-left:20px\"> <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; border-collapse:collapse !important; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none\"> <tbody> <tr> <td align=\"center\" valign=\"top\" class=\"footerContent\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; mso-table-lspace:0pt; mso-table-rspace:0pt; text-decoration:none; border-bottom:none; font-family: Helvetica, Arial, sans-serif; color:#9ca8b7; font-size:12px; line-height:18px; text-align:center\"> <strong style=\" font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none; font-weight:600; letter-spacing:0.25px\">GTEP - Grupo de Tecnologia e Engenharia de Petróleo</strong> <br><a href=\"#\" style=\"-webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; font-family: Helvetica, Arial, sans-serif; text-decoration:none; border-bottom:none; color:#9CA8B7; font-weight:normal; cursor:text\" data-hs-link-id=\"0\" target=\"_blank\">Rua Marquês de São Vicente, 225 - Edifício Padre Leonel Franca, 6º andar - Gávea, Rio de Janeiro - RJ - CEP: 22451-900 | Tel.: (21)3527-1458/59 Fax.: (21)3527-1460</a> <br><br></td></tr></tbody> </table> </td></tr></tbody> </table> </td></tr><tr> <td align=\"center\" valign=\"top\"> </td></tr></tbody> </table> </td></tr></tbody> </table> </td></tr></tbody> </table> </body></html>";
        public EmailService(IConfiguration configuration, IHttpContextAccessor httpContextAccessor)
        {
            _configuration = configuration;
            _httpContextAccessor = httpContextAccessor;
            _smtpClient = new SmtpClient(_configuraçãoSmtp.Smtp, _configuraçãoSmtp.Porta)
            {
                Credentials = new NetworkCredential(_configuraçãoSmtp.Usuário, _configuraçãoSmtp.Senha),
                EnableSsl = true,
                DeliveryMethod = SmtpDeliveryMethod.Network
            };
        }

        public async Task EnviarEmailConfirmação(string idUsuario, string emailUsuario, string codigo)
        {
            var section = _configuration.GetSection("AppSettings");
            var appsettions = section.Get<AppSettings>();
            var confirmEmail = appsettions.ConfirmEmail;

            if (confirmEmail == false) return;

            MailMessage mail = new MailMessage { Body = string.Empty };

            var configuraçãoEmail = new ConfiguraçãoEmail();
            configuraçãoEmail.To = emailUsuario;
            configuraçãoEmail.Subject = "SESTWEB - Confirmação de registro de usuário";

            mail.Sender = new MailAddress(configuraçãoEmail.From);
            mail.From = new MailAddress(configuraçãoEmail.From);
            mail.To.Add(new MailAddress(configuraçãoEmail.To));
            mail.Subject = configuraçãoEmail.Subject;

            var baseUrl = $"{_httpContextAccessor.HttpContext.Request.Scheme}://{_httpContextAccessor.HttpContext.Request.Host}";

            var urlConfirmaçãoEmail = $"{baseUrl}/confirm?id={idUsuario}&code={codigo}";
            mail.BodyEncoding = Encoding.UTF8;

            mail.IsBodyHtml = true;

            var body = new string(_template);

            body = body.Replace("__LINK_BOTAO__", urlConfirmaçãoEmail);
            body = body.Replace("__TEXTO_BOTAO__", "Clique aqui para confirmar");
            body = body.Replace("__TITULO__", "Confirmação de Registro");
            body = body.Replace("__TEXTO__", "");
            mail.Body = body;

            await _smtpClient.SendMailAsync(mail);
        }

        public async Task EnviarEsqueceuSenha(string email, string code)
        {
            var section = _configuration.GetSection("AppSettings");
            var appsettions = section.Get<AppSettings>();
            var confirmEmail = appsettions.ConfirmEmail;

            if (confirmEmail == false) return;

            MailMessage mail = new MailMessage { Body = string.Empty };

            var configuraçãoEmail = new ConfiguraçãoEmail();
            configuraçãoEmail.To = email;
            configuraçãoEmail.Subject = "SESTWEB - Recuperação de senha";

            mail.Sender = new MailAddress(configuraçãoEmail.From);
            mail.From = new MailAddress(configuraçãoEmail.From);
            mail.To.Add(new MailAddress(configuraçãoEmail.To));
            mail.Subject = configuraçãoEmail.Subject;

            var baseUrl = $"{_httpContextAccessor.HttpContext.Request.Scheme}://{_httpContextAccessor.HttpContext.Request.Host}";

            var url = $"{baseUrl}/recuperacao-senha?code={code}&email={email}";
            mail.BodyEncoding = Encoding.UTF8;

            mail.IsBodyHtml = true;

            var body = new string(_template);

            body = body.Replace("__LINK_BOTAO__", url);
            body = body.Replace("__TEXTO_BOTAO__", "Registrar nova senha");
            body = body.Replace("__TITULO__", "Registro de Nova Senha");
            body = body.Replace("__TEXTO__", "");
            mail.Body = body;

            await _smtpClient.SendMailAsync(mail);
        }

        private class ConfiguraçãoEmail
        {
            public string To { get; set; }
            public string From { get; } = "portalsest@puc-rio.br";
            public List<string> Cc { get; set; } = new List<string>();
            public List<string> Cco { get; set; } = new List<string>();
            public string Subject { get; set; }
        }

        private class ConfiguraçãoSmtp
        {
            public string Smtp { get; } = "smtp.puc-rio.br";
            public int Porta { get; } = 587;
            public string Usuário { get; } = "portalsest@puc-rio.br";
            public string Senha { get; } = "gtep@1234";
        }
    }
}
